name: Base64 Decoder & Auto Commit

on:
  schedule:
    - cron: '0 * * * *'  # 关键修改点：每小时运行一次
  workflow_dispatch:      # 支持手动触发

jobs:
  decode-and-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true  # 关键权限配置

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Run decoding script
      run: |
        python -c "import requests
        import base64

        url = 'https://lucky-term-fea6.tel13339999091.workers.dev/'

        try:
            response = requests.get(url)
            response.raise_for_status()
            encoded_content = response.text.strip()
            
            decoded_bytes = base64.b64decode(encoded_content)
            
            # 二进制写入确保数据完整性
            with open('hy2.txt', 'wb') as f:
                f.write(decoded_bytes)
            
            print('::notice::内容已写入 hy2.txt')
            
            try:
                # 日志验证用
                decoded_content = decoded_bytes.decode('utf-8')
                print('解码预览：\\n', decoded_content[:200] + '...')
            except UnicodeDecodeError:
                print('::warning::内容包含非UTF-8数据，已保存原始字节')
            
        except Exception as e:
            print(f'::error::处理失败：{str(e)}')
            exit(1)
        "

    - name: Commit and Push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 自动生成的令牌
      run: |
        # 配置 Git 身份
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # 添加并提交文件
        git add hy2.txt
        
        # 检测文件变更
        if git diff-index --quiet HEAD --; then
          echo "没有文件变更需要提交"
        else
          git commit -m "自动更新 hy2.txt [skip ci]"
          
          # 强制推送更新（使用 token 认证）
          git remote set-url origin https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}
          git push origin HEAD:main  # 根据实际分支修改
          
          echo "::notice::文件已成功推送"
        fi
